{% extends "core/base.html" %}
{% load blood_extras %}

{% block title %}Dashboard - Blood Lab{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
    <a href="{% url 'upload' %}" class="btn btn-primary">+ Enviar Exame</a>
</div>

<!-- Summary Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_exams }}</div>
        <div class="stat-label">Exames Enviados</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% if last_exam %}{{ last_exam.exam_date|date:"d/m/Y" }}{% else %}-{% endif %}
        </div>
        <div class="stat-label">√öltimo Exame</div>
    </div>
    <div class="stat-card">
        <div class="stat-value {% if abnormal_count > 0 %}text-warning{% endif %}">
            {{ abnormal_count }}
        </div>
        <div class="stat-label">Valores Alterados</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% if last_exam and last_exam.analysis %}
                {{ last_exam.analysis.alerts|length }}
            {% else %}-{% endif %}
        </div>
        <div class="stat-label">Alertas IA</div>
    </div>
</div>

{% if total_exams == 0 %}
<!-- Empty state -->
<div class="empty-state">
    <div class="empty-icon">üìã</div>
    <h2>Nenhum exame enviado</h2>
    <p>Envie seu primeiro exame de sangue para come√ßar a acompanhar seus biomarcadores.</p>
    <a href="{% url 'upload' %}" class="btn btn-primary btn-lg">Enviar Primeiro Exame</a>
</div>
{% else %}

<!-- Charts Section -->
<div class="section">
    <h2 class="section-title">Evolu√ß√£o dos Biomarcadores</h2>
    <div class="charts-grid" id="chartsGrid">
        <!-- Charts are rendered by JavaScript -->
    </div>
</div>

<!-- Recent Exams -->
<div class="section">
    <h2 class="section-title">Exames Recentes</h2>
    <div class="exam-list">
        {% for exam in recent_exams %}
        <a href="{% url 'exam_detail' exam.id %}" class="exam-list-item">
            <div class="exam-list-info">
                <div class="exam-list-date">{{ exam.exam_date|date:"d/m/Y" }}</div>
                <div class="exam-list-lab">{{ exam.lab_name|default:"Laborat√≥rio n√£o informado" }}</div>
            </div>
            <div class="exam-list-stats">
                <span class="badge">{{ exam.result_count }} resultados</span>
                {% if exam.abnormal_count > 0 %}
                <span class="badge badge-warning">{{ exam.abnormal_count }} alterados</span>
                {% endif %}
                <span class="badge badge-{{ exam.status }}">{{ exam.get_status_display }}</span>
            </div>
            <span class="exam-list-arrow">&rarr;</span>
        </a>
        {% endfor %}
    </div>
    {% if total_exams > 5 %}
    <div class="section-footer">
        <a href="{% url 'exam_history' %}" class="btn btn-outline">Ver Todos os Exames</a>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
    var chartData = {{ chart_data_json|safe }};
    if (Object.keys(chartData).length > 0) {
        renderDashboardCharts(chartData);
    }
</script>
{% endblock %}
